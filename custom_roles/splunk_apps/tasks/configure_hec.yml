---
# configure_hec.yml
# Configure HTTP Event Collector (HEC) in the splunk_httpinput app

- name: Check if splunk_httpinput app exists
  stat:
    path: "{{ splunk_home }}/etc/apps/splunk_httpinput"
  register: splunk_httpinput_exists

- name: Create local directory in splunk_httpinput app
  file:
    path: "{{ splunk_home }}/etc/apps/splunk_httpinput/local"
    state: directory
    owner: "{{ splunk_nix_user }}"
    group: "{{ splunk_nix_group }}"
    mode: '0755'
  when: splunk_httpinput_exists.stat.exists
  become: true

- name: Configure HEC in splunk_httpinput app
  copy:
    content: |
      # HTTP Event Collector Configuration
      # Generated by Ansible on {{ ansible_date_time.iso8601 }}
      
      [http]
      disabled = 0
      enableSSL = true
      port = 8088
      
      # Additional HEC settings
      [http://default]
      disabled = 0
      enableSSL = true
      dedicatedIoThreads = 2
      maxSockets = 0
      maxThreads = 0
      
    dest: "{{ splunk_home }}/etc/apps/splunk_httpinput/local/inputs.conf"
    owner: "{{ splunk_nix_user }}"
    group: "{{ splunk_nix_group }}"
    mode: '0644'
    backup: true
  when: splunk_httpinput_exists.stat.exists
  become: true
  notify: restart splunk

- name: Create HEC tokens configuration
  copy:
    content: |
      # HEC Token Configuration
      # Generated by Ansible on {{ ansible_date_time.iso8601 }}
      
      [http://hec_token_{{ hec_token_name | default('default') }}]
      disabled = 0
      token = {{ hec_token_value | default('00000000-0000-0000-0000-000000000000') }}
      sourcetype = _json
      index = {{ hec_default_index | default('main') }}
      
    dest: "{{ splunk_home }}/etc/apps/splunk_httpinput/local/inputs.conf"
    owner: "{{ splunk_nix_user }}"
    group: "{{ splunk_nix_group }}"
    mode: '0644'
    backup: true
  when: 
    - splunk_httpinput_exists.stat.exists
    - hec_tokens is defined
  become: true
  notify: restart splunk

- name: Display HEC configuration status
  debug:
    msg:
      - "HEC Configuration Status:"
      - "  splunk_httpinput app exists: {{ splunk_httpinput_exists.stat.exists }}"
      - "  Configuration applied: {{ splunk_httpinput_exists.stat.exists }}"
      - "  HEC will be enabled on port 8088 with SSL"
      - "  Splunk restart required for changes to take effect"